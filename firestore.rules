rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // 사용자 프로필 - 본인만 읽기/쓰기 가능
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // 자산 - 본인 자산만 접근 가능
    match /assets/{assetId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // 상품 - 모든 인증된 사용자가 읽기 가능
    match /products/{productId} {
      allow read: if request.auth != null;
      allow write: if false; // 관리자만 수정 가능 (콘솔에서)
    }

    // 예금 기록 - 본인만 접근 가능
    match /deposits/{depositId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // 출금 요청 - 본인만 접근 가능
    match /withdrawals/{withdrawId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // 거래 내역 - 본인만 접근 가능
    match /transactions/{txId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // 이자 수령 기록 - 본인만 접근 가능
    match /interestClaims/{claimId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // 수신자 목록 - 본인만 접근 가능
    match /recipients/{recipientId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // 즐겨찾기 - 본인만 접근 가능
    match /favorites/{favoriteId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // 환율 - 모든 인증된 사용자가 읽기 가능
    match /exchangeRates/{rateId} {
      allow read: if request.auth != null;
      allow write: if false; // 시스템만 수정 가능
    }

    // OTP 코드 - Cloud Functions만 접근 가능
    match /otpCodes/{email} {
      allow read, write: if false; // 클라이언트 접근 불가, Cloud Functions만 접근
    }

    // 블록체인 예금 통계 - 읽기만 가능
    match /blockchain_deposits/{depositId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // 플랫폼 통계 - 읽기만 가능
    match /platformStats/{productId} {
      allow read: if request.auth != null;
      allow write: if false; // Cloud Functions만 수정 가능
    }
  }
}
